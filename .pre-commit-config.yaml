# Pre-commit hooks for DevSecOps Template
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

default_stages: [pre-commit]
fail_fast: false

repos:
  # ===========================================
  # General Checks
  # ===========================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
      - id: end-of-file-fixer
        name: Fix end of files
      - id: check-yaml
        name: Check YAML syntax
        args: ['--unsafe']  # Allow custom tags
      - id: check-json
        name: Check JSON syntax
      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=1000']
      - id: check-merge-conflict
        name: Check for merge conflicts
      - id: detect-private-key
        name: Detect private keys
      - id: check-case-conflict
        name: Check case conflicts
      - id: mixed-line-ending
        name: Fix line endings
        args: ['--fix=lf']

  # ===========================================
  # Security - Secret Detection
  # ===========================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.4
    hooks:
      - id: gitleaks
        name: Detect secrets with Gitleaks
        entry: gitleaks protect --verbose --redact --staged

  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0 
    hooks:
      - id: detect-secrets
        name: Detect secrets (Yelp)
        args: ['--baseline', '.secrets.baseline']
        exclude: 'package-lock.json|\.secrets\.baseline'

  # ===========================================
  # JavaScript/Node.js
  # ===========================================
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v8.56.0
    hooks:
      - id: eslint
        name: ESLint
        files: \.(js|jsx|ts|tsx)$
        types: [file]
        additional_dependencies:
          - eslint@8.56.0
          - eslint-plugin-security@2.1.0
        args: ['--fix', '--max-warnings=0']

  # ===========================================
  # Terraform/IaC
  # ===========================================
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.86.0
    hooks:
      - id: terraform_fmt
        name: Terraform format
      - id: terraform_validate
        name: Terraform validate
      - id: terraform_docs
        name: Terraform docs
        args:
          - '--args=--output-file=README.md'
      - id: terraform_tflint
        name: TFLint
        args:
          - '--args=--only=terraform_deprecated_interpolation'
          - '--args=--only=terraform_deprecated_index'
          - '--args=--only=terraform_unused_declarations'
          - '--args=--only=terraform_comment_syntax'
          - '--args=--only=terraform_documented_outputs'
          - '--args=--only=terraform_documented_variables'
          - '--args=--only=terraform_typed_variables'
          - '--args=--only=terraform_naming_convention'
          - '--args=--only=terraform_required_version'
          - '--args=--only=terraform_required_providers'

  - repo: https://github.com/bridgecrewio/checkov
    rev: 3.2.0
    hooks:
      - id: checkov
        name: Checkov IaC scan
        args: ['--framework', 'terraform,kubernetes,dockerfile']
        stages: [pre-push]  # Only on push (slow)

  # ===========================================
  # Kubernetes/YAML
  # ===========================================
  - repo: https://github.com/yannh/kubeconform
    rev: v0.6.4
    hooks:
      - id: kubeconform
        name: Validate Kubernetes manifests
        args:
          - '-strict'
          - '-ignore-missing-schemas'
          - '-skip=CustomResourceDefinition'
        files: 'infra/k8s/.*\.yaml$'

  # ===========================================
  # Docker
  # ===========================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.0
    hooks:
      - id: hadolint-docker
        name: Hadolint Dockerfile linter
        entry: hadolint
        args: ['--ignore', 'DL3018', '--ignore', 'DL3008']

  # ===========================================
  # Markdown/Documentation
  # ===========================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.39.0
    hooks:
      - id: markdownlint
        name: Markdown lint
        args: ['--fix', '--disable', 'MD013', 'MD033', 'MD041', '--']

  # ===========================================
  # Commit Message
  # ===========================================
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v4.10.0
    hooks:
      - id: commitizen
        name: Check commit message format
        stages: [commit-msg]

  # ===========================================
  # SAST - Semgrep (on push only - slow)
  # ===========================================
  - repo: https://github.com/returntocorp/semgrep
    rev: v1.145.0
    hooks:
      - id: semgrep
        name: Semgrep SAST
        args: ['--config', 'auto', '--error', '--quiet']
        stages: [pre-push]

# CI configuration for pre-commit
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit.com hooks
  autofix_prs: true
  autoupdate_branch: 'develop'
  autoupdate_schedule: monthly
  skip: [checkov, semgrep]  # Skip slow hooks in CI
  submodules: false
