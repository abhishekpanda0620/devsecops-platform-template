# Observability Stack - Production Environment Values
# High-availability configuration with proper security

# Prometheus Stack - Production config
prometheus:
  enabled: true

  prometheusOperator:
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 400m
        memory: 512Mi

  prometheus:
    prometheusSpec:
      retention: 30d
      retentionSize: "50GB"
      replicas: 2  # HA mode
      resources:
        requests:
          cpu: 500m
          memory: 2Gi
        limits:
          cpu: 2000m
          memory: 4Gi
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: "gp3"  # AWS EBS gp3
            resources:
              requests:
                storage: 100Gi

      # Pod anti-affinity for HA
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: prometheus
              topologyKey: kubernetes.io/hostname

  alertmanager:
    enabled: true
    alertmanagerSpec:
      replicas: 2  # HA mode
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: "gp3"
            resources:
              requests:
                storage: 10Gi

    # Production alert routing
    config:
      global:
        resolve_timeout: 5m
        slack_api_url: "" # Set via secret
      route:
        group_by: ['alertname', 'namespace', 'severity']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        receiver: 'default-receiver'
        routes:
          - match:
              severity: critical
            receiver: 'pagerduty-critical'
            continue: true
          - match:
              severity: warning
            receiver: 'slack-warnings'
      receivers:
        - name: 'default-receiver'
          slack_configs:
            - channel: '#alerts'
              send_resolved: true
        - name: 'pagerduty-critical'
          pagerduty_configs:
            - service_key: "" # Set via secret
              severity: critical
        - name: 'slack-warnings'
          slack_configs:
            - channel: '#alerts-warnings'
              send_resolved: true

  grafana:
    enabled: true
    replicas: 2  # HA mode
    adminPassword: "" # MUST be set via secret

    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi

    persistence:
      enabled: true
      storageClassName: "gp3"
      size: 20Gi

    # Production security settings
    grafana.ini:
      server:
        root_url: "https://grafana.example.com"
      security:
        admin_user: admin
        disable_gravatar: true
        cookie_secure: true
        strict_transport_security: true
      auth:
        disable_login_form: false
      auth.generic_oauth:
        enabled: false  # Enable when OIDC is configured
      analytics:
        reporting_enabled: false
        check_for_updates: false

    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
      hosts:
        - grafana.example.com
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.example.com

  nodeExporter:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

  kubeStateMetrics:
    enabled: true
    replicas: 2
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

# Loki - Production setup
loki:
  enabled: true

  loki:
    auth_enabled: true  # Enable multi-tenancy

    limits_config:
      retention_period: 720h  # 30 days
      ingestion_rate_mb: 20
      ingestion_burst_size_mb: 40
      max_streams_per_user: 50000

    storage:
      type: s3
      s3:
        region: us-east-1
        bucketnames: loki-logs-prod
        # Use IRSA for AWS authentication

    replicas: 2

  promtail:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

# Tempo - Enable tracing in production
tempo:
  enabled: true

  tempo:
    replicas: 2
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi

    storage:
      trace:
        backend: s3
        s3:
          bucket: tempo-traces-prod
          region: us-east-1
