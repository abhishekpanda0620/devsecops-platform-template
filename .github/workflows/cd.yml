# CD Pipeline - Continuous Deployment with GitOps
# Handles deployment to Kubernetes via ArgoCD

name: CD Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      version:
        description: 'Image version to deploy'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/user-service

permissions:
  contents: write
  packages: read

jobs:
  # ===========================================
  # Determine deployment parameters
  # ===========================================
  prepare:
    name: ðŸ“‹ Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.params.outputs.environment }}
      version: ${{ steps.params.outputs.version }}
      image: ${{ steps.params.outputs.image }}
    
    steps:
      - name: Determine parameters
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Tag push - deploy to staging first
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          fi
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT

  # ===========================================
  # Verify image exists and is signed
  # ===========================================
  verify:
    name: ðŸ” Verify Image
    runs-on: ubuntu-latest
    needs: [prepare]
    
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify image signature
        run: |
          cosign verify \
            --certificate-identity-regexp=".*" \
            --certificate-oidc-issuer-regexp=".*" \
            ${{ needs.prepare.outputs.image }}:${{ needs.prepare.outputs.version }}

  # ===========================================
  # Update Kubernetes manifests
  # ===========================================
  update-manifests:
    name: ðŸ“ Update Manifests
    runs-on: ubuntu-latest
    needs: [prepare, verify]
    environment: ${{ needs.prepare.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
      
      - name: Update image tag
        run: |
          cd infra/k8s/overlays/${{ needs.prepare.outputs.environment }}
          kustomize edit set image user-service=${{ needs.prepare.outputs.image }}:${{ needs.prepare.outputs.version }}
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add infra/k8s/overlays/
          git commit -m "chore: deploy ${{ needs.prepare.outputs.version }} to ${{ needs.prepare.outputs.environment }}
          
          Automated deployment triggered by CD pipeline.
          
          Image: ${{ needs.prepare.outputs.image }}:${{ needs.prepare.outputs.version }}
          Environment: ${{ needs.prepare.outputs.environment }}
          Triggered by: ${{ github.actor }}
          " || echo "No changes to commit"
          git push

  # ===========================================
  # Wait for ArgoCD sync
  # ===========================================
  wait-sync:
    name: â³ Wait for Sync
    runs-on: ubuntu-latest
    needs: [prepare, update-manifests]
    if: needs.prepare.outputs.environment != 'prod'
    
    steps:
      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting for ArgoCD to sync..."
          echo "In production, this would use ArgoCD CLI to wait for sync completion"
          sleep 30

  # ===========================================
  # Run smoke tests
  # ===========================================
  smoke-tests:
    name: ðŸ§ª Smoke Tests
    runs-on: ubuntu-latest
    needs: [prepare, wait-sync]
    if: needs.prepare.outputs.environment != 'prod'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against ${{ needs.prepare.outputs.environment }}..."
          # In production, this would run actual HTTP tests against the deployed service
          echo "âœ… Health check passed"
          echo "âœ… API endpoints responding"
          echo "âœ… Metrics endpoint available"

  # ===========================================
  # Production deployment (manual approval)
  # ===========================================
  deploy-prod:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, smoke-tests]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    environment: 
      name: prod
      url: https://api.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
      
      - name: Update production image tag
        run: |
          cd infra/k8s/overlays/prod
          kustomize edit set image user-service=${{ needs.prepare.outputs.image }}:${{ needs.prepare.outputs.version }}
      
      - name: Commit and push production changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add infra/k8s/overlays/prod/
          git commit -m "chore: deploy ${{ needs.prepare.outputs.version }} to production
          
          Production deployment after staging verification.
          
          Image: ${{ needs.prepare.outputs.image }}:${{ needs.prepare.outputs.version }}
          Approved by: ${{ github.actor }}
          " || echo "No changes to commit"
          git push

  # ===========================================
  # Rollback on failure
  # ===========================================
  rollback:
    name: âª Rollback
    runs-on: ubuntu-latest
    needs: [prepare, smoke-tests]
    if: failure() && needs.smoke-tests.result == 'failure'
    
    steps:
      - name: Trigger rollback
        run: |
          echo "Smoke tests failed! Initiating rollback..."
          echo "In production, this would trigger ArgoCD rollback"
          # argocd app rollback user-service

  # ===========================================
  # Deployment summary
  # ===========================================
  summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [prepare, update-manifests, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.prepare.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.prepare.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ needs.prepare.outputs.image }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Manifest Update | ${{ needs.update-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
